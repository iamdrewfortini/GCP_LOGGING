#!/usr/bin/env bash
# Wix-like local dev CLI for GCP_LOGGING
# Usage:
#   ./gcl setup   # install deps, prepare env files
#   ./gcl dev     # start firebase emulators + frontend dev server
#   ./gcl emu     # start firebase emulators only
#   ./gcl build   # build frontend assets for hosting emulator
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRONTEND_DIR="$ROOT/frontend"
FUNCS_DIR="$ROOT/functions/firebase"
DEFAULT_PROJECT_ID="diatonic-ai-gcp"
DEFAULT_REGION="us-central1"
EMULATOR_ONLY_LIST="auth,firestore,storage,functions,pubsub,database,hosting,ui,logging"
FIREBASE_BIN=""

ensure_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "âŒ Missing required command: $1" >&2
    exit 1
  fi
}

ensure_firebase() {
  if command -v firebase >/dev/null 2>&1; then
    FIREBASE_BIN="firebase"
  else
    FIREBASE_BIN="npx firebase-tools"
  fi
}

load_env() {
  set -a
  [ -f "$ROOT/.env" ] && source "$ROOT/.env"
  set +a
}

copy_env_templates() {
  if [ -f "$ROOT/.env.example" ] && [ ! -f "$ROOT/.env" ]; then
    cp "$ROOT/.env.example" "$ROOT/.env"
    echo "ðŸ“ Created .env from .env.example"
  fi
  if [ -f "$FRONTEND_DIR/.env.example" ] && [ ! -f "$FRONTEND_DIR/.env.local" ]; then
    cp "$FRONTEND_DIR/.env.example" "$FRONTEND_DIR/.env.local"
    echo "ðŸ“ Created frontend/.env.local from .env.example"
  fi
}

install_node() {
  ensure_cmd npm
  if [ -d "$FRONTEND_DIR" ]; then
    pushd "$FRONTEND_DIR" >/dev/null
    if [ -f package-lock.json ]; then
      npm ci
    else
      npm install
    fi
    popd >/dev/null
  fi
}

install_python() {
  ensure_cmd python3
  if [ -f "$ROOT/requirements.txt" ]; then
    python3 -m pip install --user -r "$ROOT/requirements.txt"
  fi
  if [ -f "$FUNCS_DIR/requirements.txt" ]; then
    python3 -m pip install --user -r "$FUNCS_DIR/requirements.txt"
  fi
}

cmd_setup() {
  copy_env_templates
  install_node
  install_python
  ensure_firebase
  $FIREBASE_BIN --version >/dev/null
  echo "âœ… Setup complete."
}

start_emulators() {
  ensure_firebase
  load_env
  export PROJECT_ID="${PROJECT_ID:-$DEFAULT_PROJECT_ID}"
  export REGION="${REGION:-$DEFAULT_REGION}"
  export GOOGLE_CLOUD_PROJECT="$PROJECT_ID"

  mkdir -p "$ROOT/.firebase"
  echo "ðŸš€ Starting Firebase emulators for project $PROJECT_ID ..."
  $FIREBASE_BIN emulators:start \
    --only "$EMULATOR_ONLY_LIST" \
    --project "$PROJECT_ID" \
    --import "$ROOT/.firebase/local" \
    --export-on-exit "$ROOT/.firebase/local"
}

cmd_dev() {
  ensure_cmd npm
  ensure_cmd python3
  copy_env_templates
  load_env
  export VITE_USE_FIREBASE_EMULATORS="${VITE_USE_FIREBASE_EMULATORS:-true}"

  start_emulators &
  EMU_PID=$!

  if [ -d "$FRONTEND_DIR" ]; then
    pushd "$FRONTEND_DIR" >/dev/null
    echo "ðŸŒ Starting frontend dev server on http://localhost:5173 ..."
    npm run dev -- --host --port 5173 &
    FRONT_PID=$!
    popd >/dev/null
  else
    FRONT_PID=""
  fi

  trap 'echo "â¹ï¸  Shutting down..."; [ -n "$EMU_PID" ] && kill "$EMU_PID" 2>/dev/null || true; [ -n "${FRONT_PID:-}" ] && kill "$FRONT_PID" 2>/dev/null || true' INT TERM EXIT

  if [ -n "${FRONT_PID:-}" ]; then
    wait -n "$EMU_PID" "$FRONT_PID"
  else
    wait "$EMU_PID"
  fi
}

cmd_emu() {
  start_emulators
}

cmd_build() {
  ensure_cmd npm
  if [ -d "$FRONTEND_DIR" ]; then
    pushd "$FRONTEND_DIR" >/dev/null
    npm run build
    popd >/dev/null
  fi
  echo "âœ… Build complete. Hosting emulator will serve frontend/dist."
}

usage() {
  cat <<'EOF'
gcl - Wix-like local dev helper

Commands:
  setup   Install deps, prepare env files
  dev     Start Firebase emulators + frontend dev server
  emu     Start Firebase emulators only
  build   Build frontend assets for hosting emulator
EOF
}

case "${1:-}" in
  setup) shift; cmd_setup "$@";;
  dev) shift; cmd_dev "$@";;
  emu) shift; cmd_emu "$@";;
  build) shift; cmd_build "$@";;
  *) usage; exit 1;;
esac
