# Firebase Data Model

**Date:** 2025-12-15
**Goal:** Schema design for realtime application state.

## 1. Collections Structure

### `users/{userId}`
- **Purpose:** User preferences and global settings.
- **Fields:**
  - `email`: string
  - `displayName`: string
  - `settings`: map (theme, default_project, etc.)
  - `createdAt`: timestamp
  - `lastLoginAt`: timestamp

### `sessions/{sessionId}`
- **Purpose:** Conversation metadata.
- **Fields:**
  - `userId`: string (owner)
  - `title`: string (auto-generated or user set)
  - `createdAt`: timestamp
  - `updatedAt`: timestamp
  - `status`: string ('active', 'archived', 'deleted')
  - `summary`: string (AI generated summary)
  - `stats`: map (messageCount, tokenCount)

### `sessions/{sessionId}/messages/{messageId}`
- **Purpose:** Chat history.
- **Fields:**
  - `role`: string ('user', 'assistant', 'system')
  - `content`: string (markdown)
  - `createdAt`: timestamp
  - `metadata`: map
    - `tokens`: number
    - `latency_ms`: number
    - `tools_used`: array[string]
    - `citations`: array[object]
  - `attachments`: array[object] (file references)

### `artifacts/{artifactId}`
- **Purpose:** structured outputs generated by the agent (Charts, SQL, Reports).
- **Fields:**
  - `sessionId`: string
  - `messageId`: string (trigger)
  - `type`: string ('sql_query', 'dashboard_config', 'incident_report')
  - `content`: map/string
  - `createdAt`: timestamp
  - `version`: number

## 2. Indexes (`firestore.indexes.json`)

```json
{
  "indexes": [
    {
      "collectionGroup": "sessions",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "updatedAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "messages",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "createdAt", "order": "ASCENDING" }
      ]
    }
  ]
}
```

## 3. Security Rules (`firestore.rules`)

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // User helper
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Sessions: Users can only read/write their own sessions
    match /sessions/{sessionId} {
      allow create: if request.auth != null;
      allow read, update, delete: if isOwner(resource.data.userId);
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read, write: if isOwner(get(/databases/$(database)/documents/sessions/$(sessionId)).data.userId);
      }
    }
    
    // Artifacts: Linked to session ownership
    match /artifacts/{artifactId} {
      allow read: if isOwner(resource.data.userId);
      // Only backend (via Admin SDK) usually writes artifacts, 
      // but if user edits them:
      allow update: if isOwner(resource.data.userId);
    }
  }
}
```
